openapi: 3.0.3
info:
  title: Example Payments API (MVP)
  version: "1.0.0"
  description: |
    Backend MVP API. Uses server-side session (HttpOnly cookie).
    Dates/times use ISO 8601 in UTC.
servers:
  - url: https://api.example.com/v1
security:
  - cookieAuth: []
tags:
  - name: Auth
    description: Authentication and session endpoints
  - name: Users
  - name: Transfers
paths:
  /login:
    post:
      tags: [Auth]
      summary: Login with email and password
      operationId: login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            examples:
              example:
                value:
                  email: taro@example.com
                  password: passw0rd
      responses:
        "200":
          description: OK (session created; Set-Cookie returned)
          headers:
            Set-Cookie:
              description: Session cookie
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'
              examples:
                example:
                  value: { ok: true }
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                INVALID_CREDENTIALS:
                  value: { error_code: "INVALID_CREDENTIALS", message: "email or password is incorrect" }
        default:
          $ref: '#/components/responses/ErrorResponse'
  /logout:
    post:
      tags: [Auth]
      summary: Logout and invalidate the session
      operationId: logout
      responses:
        "204":
          description: No Content (session invalidated)
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                INVALID_CREDENTIALS:
                  value: { error_code: "INVALID_CREDENTIALS", message: "login required" }
        default:
          $ref: '#/components/responses/ErrorResponse'
  /me:
    get:
      tags: [Auth]
      summary: Get current user's profile and account
      operationId: getMe
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MeResponse'
              examples:
                example:
                  value:
                    user:
                      id: 1
                      name: Taro
                      icon: u1.png
                    account:
                      account_number: 12345678
                      deposit: 10000
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        default:
          $ref: '#/components/responses/ErrorResponse'
  /users:
    get:
      tags: [Users]
      summary: List users (recipients)
      operationId: listUsers
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
              examples:
                example:
                  value:
                    - { id: 2, name: Hanako, icon: u2.png }
                    - { id: 3, name: Jiro,   icon: u3.png }
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        default:
          $ref: '#/components/responses/ErrorResponse'
  /users/{user_id}:
    get:
      tags: [Users]
      summary: Get recipient user details
      operationId: getUserById
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: Target user ID.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDetailResponse'
              examples:
                example:
                  value:
                    user: { id: 2, name: Hanako, icon: u2.png }
                    account: { account_number: 98765432 }
        "400":
          description: Invalid user id.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                INVALID_USER_ID:
                  value: { error_code: "INVALID_USER_ID", message: "user_id must be a positive integer" }
        "404":
          description: User not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                USER_NOT_FOUND:
                  value: { error_code: "USER_NOT_FOUND", message: "User was not found" }
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        default:
          $ref: '#/components/responses/ErrorResponse'
  /transfers:
    post:
      tags: [Transfers]
      summary: Create a transfer
      operationId: createTransfer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransferCreateRequest'
            examples:
              example:
                value:
                  to_user_id: 2
                  amount: 5000
                  message: "ランチ代ありがとう！"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompletedResponse'
              examples:
                example:
                  value: { is_completed: true }
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "409":
          description: Insufficient funds
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        default:
          $ref: '#/components/responses/ErrorResponse'
components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session
  responses:
    UnauthorizedError:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            UNAUTHORIZED:
              value: { error_code: "UNAUTHORIZED", message: "login required" }
    ErrorResponse:
      description: Error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
  schemas:
    OkResponse:
      type: object
      properties:
        ok:
          type: boolean
      required: [ok]
    CompletedResponse:
      type: object
      properties:
        completed:
          type: boolean
      required: [completed]
    Error:
      type: object
      required: [error_code, message]
      properties:
        error_code:
          type: string
          description: Machine-readable error code.
        message:
          type: string
          description: Human-readable error message.
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
    User:
      type: object
      required: [id, name, icon]
      properties:
        id:
          type: integer
          format: int32
        name:
          type: string
        icon:
          type: string
          description: File name of the stored user icon.
    Account:
      type: object
      required: [account_number, deposit]
      properties:
        account_number:
          type: integer
          description: Account number (integer).
        deposit:
          type: integer
          description: Deposit amount in JPY (integer).
          example: 10000
    AccountPublic:
      type: object
      required: [account_number]
      properties:
        account_number:
          type: integer
          format: int32
    Transfer:
      type: object
      required: [id, from_user_id, to_user_id, amount, date, completed]
      properties:
        id:
          type: integer
          format: int32
        from_user_id:
          type: integer
          format: int32
        to_user_id:
          type: integer
          format: int32
        amount:
          type: integer
          description: Transfer amount in JPY (integer).
        message:
          type: string
          nullable: true
        date:
          type: string
          format: date-time
          description: ISO 8601, UTC
        completed:
          type: boolean
    MeResponse:
      type: object
      required: [user, account]
      properties:
        user:
          $ref: '#/components/schemas/User'
        account:
          $ref: '#/components/schemas/Account'
    UserDetailResponse:
      type: object
      required: [user, account]
      properties:
        user:
          $ref: '#/components/schemas/User'
        account:
          $ref: '#/components/schemas/AccountPublic'
    TransferCreateRequest:
      type: object
      required: [to_user_id, amount]
      properties:
        to_user_id:
          type: integer
          format: int32
        amount:
          type: integer
          minimum: 1
          description: Amount in JPY (integer).
        message:
          type: string
          nullable: true
